# Ichimoku Cloud Trading Assistant

A Python-based assistant that implements Ichimoku Cloud trading strategies with fast backtesting, PDF reporting, and LLM-powered optimization that can auto-generate updated strategy YAMLs.

## Overview

This assistant focuses on the Ichimoku Cloud indicator system to generate trading signals for cryptocurrency pairs (BTC/USDT, ETH/USDT, SOL/USDT). It features:

- Historical data collection from cryptocurrency exchanges
- Ichimoku Cloud indicator calculations and signal generation
- Comprehensive backtesting framework
- Multiple pre-configured trading strategies
- LLM-powered strategy optimization (OpenAI and Google Gemini)
- Auto-generated optimized YAML strategy configs from LLM suggestions
- Detailed reporting with visualizations (multi-page PDF)
- Token usage accounting in LLM PDFs (provider, model, prompt/output token counts)

## Project Structure

```
Trading_Bot/
│
├── app.py                 # Main entry point - CLI interface
├── requirements.txt       # Python dependencies
├── .env                  # Environment variables (API keys)
├── .gitignore           # Git ignore file
│
├── config/              # Strategy configurations
│   ├── strategies.yaml              # Canonical strategy definitions
│   └── llm_strategy_config/         # YAMLs auto-generated by LLM optimization
│
├── data/                # SQLite databases and schema
│   ├── symbol_schema.sql    # Database schema definition
│   ├── trading_data_BTC.db  # Bitcoin historical data
│   ├── trading_data_ETH.db  # Ethereum historical data
│   └── trading_data_SOL.db  # Solana historical data
│
├── data_fetching/       # Data collection modules
│   ├── __init__.py
│   ├── collect_historical_data.py  # Main data collection script
│   ├── data_fetcher.py            # CCXT integration
│   ├── data_manager.py            # Database operations
│   └── database_init.py           # Database initialization
│
├── strategy/            # Trading strategy implementation
│   ├── compute_ichimoku_to_sql.py  # Ichimoku calculations
│   └── ichimoku_strategy.py        # Strategy logic
│
├── backtesting/         # Backtesting engine
│   └── ichimoku_backtester.py      # Main backtester
│
├── llm_analysis/        # LLM integration for optimization
│   ├── __init__.py
│   ├── env_loader.py          # Load LLM credentials and defaults
│   ├── llm_client.py          # LLM API client (OpenAI, Gemini)
│   ├── payload_builder.py     # Build compact LLM payloads
│   ├── prompt_builder.py      # Generate prompts (single-number suggestions)
│   ├── report_text_renderer.py # Parse and render LLM responses
│   ├── token_utils.py         # Token counting utilities
│   └── pdf_writer.py          # LLM PDF generation
│
├── reporting/           # Report generation
│   ├── __init__.py
│   └── report_generator.py    # Generate backtest reports
│
└── reports/            # Generated reports directory
```

## Database Schema

The project uses SQLite databases with a per-symbol architecture. Each cryptocurrency has its own database file containing:

### Tables

1. **ohlcv_data** - Historical price and volume data
   - `id`: Primary key
   - `timestamp`: Date/time of the candle
   - `open`, `high`, `low`, `close`: Price data
   - `volume`: Trading volume
   - `timeframe`: 1h, 4h, or 1d

2. **ichimoku_data** - Calculated Ichimoku indicators
   - `id`: Primary key
   - `ohlcv_id`: Foreign key to ohlcv_data
   - `tenkan_sen`: Conversion line (9-period)
   - `kijun_sen`: Base line (26-period)
   - `senkou_span_a`: Leading span A
   - `senkou_span_b`: Leading span B (52-period)
   - `chikou_span`: Lagging span
   - `cloud_color`: Bullish (green) or bearish (red)
   - `price_position`: Above, in, or below cloud
   - `trend_strength`: Strong bullish to strong bearish
   - `tk_cross`: Tenkan/Kijun cross signals

3. **metadata** - Database information
   - Key-value pairs for database metadata

### Views

- `ohlcv_ichimoku_view`: Combined OHLCV and Ichimoku data
- `latest_data_view`: Summary of available data per timeframe
- `ichimoku_signals_view`: Trading signals based on Ichimoku

## Installation

1. Clone the repository:
```bash
git clone https://github.com/yourusername/Trading_Bot.git
cd Trading_Bot
```

2. Create a virtual environment:
```bash
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
```

3. Install dependencies:
```bash
pip install -r requirements.txt
```

4. Set up environment variables:
Create a `.env` file in the project root with your API keys (optional if already exported in your shell):
```
# Exchange API (if needed for live data)
EXCHANGE_API_KEY=your_exchange_api_key
EXCHANGE_API_SECRET=your_exchange_api_secret

# LLM APIs for optimization
OPENAI_API_KEY=your_openai_api_key
GEMINI_API_KEY=your_gemini_api_key
```

## Usage

### Running the Application

Start the CLI interface:
```bash
python app.py
```

The main menu provides three options:

1. **Collect Historical Data**: Downloads OHLCV data for all configured symbols
2. **Compute Ichimoku**: Calculates Ichimoku indicators for selected symbols
3. **Backtest Ichimoku Strategy**: Run backtests with various strategies

### Workflow Example

1. **Initial Setup**:
   - Run option 1 to collect historical data
   - Run option 2 to compute Ichimoku indicators

2. **Backtesting**:
   - Select option 3
   - Choose a strategy from the available list
   - Select symbol (BTC, ETH, or SOL)
   - Select timeframe (1h, 4h, or 1d)
   - Optionally set a start date
   - Review generated reports in the `reports/` directory

3. **LLM Optimization** (Optional):
   - After backtesting, choose to generate the LLM optimization report
   - Select prompt variant (analyst or risk-focused)
   - Choose LLM provider (OpenAI or Gemini). Leave blank to use default from .env
   - The PDF starts with a usage header showing provider, model, and token counts
   - A YAML with optimized settings is also written to config/llm_strategy_config/

## Trading Strategies

Strategies are defined in config/strategies.yaml. Each strategy shares the same basic structure:
- ichimoku_parameters: tenkan_period, kijun_period, senkou_b_period, chikou_offset, senkou_offset
- signal_conditions:
  - buy_conditions: an array of conditions from the set:
    - PriceAboveCloud, PriceBelowCloud
    - TenkanAboveKijun, TenkanBelowKijun
    - SpanAaboveSpanB, SpanAbelowSpanB
    - ChikouAbovePrice, ChikouAboveCloud
  - sell_conditions: any of the same condition names
  - buy_logic / sell_logic: AND or OR
- risk_management: stop_loss_pct, take_profit_pct, close_on_sell_signal, trailing_stop, max_position_size_pct, risk_per_trade_pct
- position_sizing: method (fixed), fixed_size

Included groups in strategies.yaml:
- Group 1 (TK exit): sell on TenkanBelowKijun
- Group 2 (Span exit): sell on SpanAbelowSpanB
- Group 3 (TK+Span exit): sell on both TenkanBelowKijun and SpanAbelowSpanB

Examples (abbreviated):
- strategy_02_tk_sell “Cloud-TK-SpanA Base TK Exit”
  - Buy: PriceAboveCloud, TenkanAboveKijun, SpanAaboveSpanB (AND)
  - Sell: TenkanBelowKijun
  - Ichimoku: 9/26/52, offsets 26/26
- strategy_05_tk_sell “Full Confirmation TK Exit”
  - Buy adds Chikou confirmations: ChikouAboveCloud, ChikouAbovePrice
  - Sell: TenkanBelowKijun

You can add or adjust strategies by editing config/strategies.yaml. LLM optimization can generate new YAMLs in config/llm_strategy_config/, which you can review and then promote into strategies.yaml if desired.

## Requirements

- Python 3.8+
- SQLite3
- Internet connection for data fetching and LLM APIs
- Sufficient disk space for historical data storage

## Reporting

Backtest PDF (reports/*.pdf):
- Page 1: Title and Executive Summary (metrics, insights)
- Page 2: Performance Overview
  - Equity curve, Monthly returns, Drawdown chart, P&L distribution
- Page 3: Trading Analysis
  - P&L by Day of Week, Exit Reason Distribution, Underwater Chart (Drawdown from Peak)
- Page 4: Trade Details — Top 20 Trades by Absolute P&L

LLM Optimization PDF (reports/*_llm.pdf):
- Header line shows provider, model, and token usage (prompt, output, total)
- Memo plus structured suggestions parsed from the model output

## Notes

- Historical data starts from August 1, 2020
- Backtesting uses fixed position sizing (100% of equity)
- Commission: 0.1%, Slippage: 0.03%
- Default LLM models: OpenAI gpt-4o-mini, Gemini gemini-2.5-pro
- In the CLI, provider override prompt accepts openai|gemini (blank = default). There is no model override prompt.
- The `archive/` folder contains old code and is excluded from git

## License

[Your License Here]

## Contributing

[Your Contributing Guidelines Here]